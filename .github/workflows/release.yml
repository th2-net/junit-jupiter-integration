name: Build and release Java distributions to sonatype.

on:
  workflow_dispatch:

env:
  VERSION_FILE: gradle.properties
  VERSION_PATTERN: '(?<=release_version=).+'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      CURRENT_VERSION: ${{ steps.versions.outputs.CURRENT_VERSION }}
      NEXT_VERSION: ${{ steps.versions.outputs.NEXT_VERSION }}
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: Get version
        id: versions
        uses: HardNorth/github-version-generate@v1.4.0
        with:
          version-source: file
          version-file: ${{ env.VERSION_FILE }}
          version-file-extraction-pattern: ${{ env.VERSION_PATTERN }}
  build:
    uses: th2-net/.github/.github/workflows/compound-java.yml@main
    with:
      build-target: 'Sonatype'
      gradleVersion: "8"
      createTag: true
      scanner-enabled: false # because we don't really care about it here
    secrets:
      sonatypeUsername: ${{ secrets.SONATYPE_NEXUS_USERNAME }}
      sonatypePassword: ${{ secrets.SONATYPE_NEXUS_PASSWORD }}
      sonatypeSigningKey: ${{ secrets.SONATYPE_GPG_ARMORED_KEY }}
      sonatypeSigningPassword: ${{ secrets.SONATYPE_SIGNING_PASSWORD }}
  create-release:
    runs-on: ubuntu-latest
    needs:
      - build
      - version
    permissions:
      contents: write
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: Build changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          toTag: ${{ needs.build.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create release
        id: create_release
        uses: ncipollo/release-action@v1.14.0
        with:
          body: ${{ steps.build_changelog.outputs.changelog }}
          name: Release ${{ needs.version.outputs.CURRENT_VERSION }}
          tag: ${{ needs.version.outputs.CURRENT_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}
  update-version:
    runs-on: ubuntu-latest
    needs:
      - create-release
      - version
    permissions:
      contents: write
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Prepare next dev version
        id: prepare_next_dev
        run: |
          sed -i -e 's/${{ needs.version.outputs.CURRENT_VERSION }}/${{ needs.version.outputs.NEXT_VERSION }}/g' gradle.properties
      - name: Commit next dev version
        id: commit_next_dev
        uses: EndBug/add-and-commit@v9
        with:
          add: "['gradle.properties']"
          default_author: github_actions
          message: "Prepare next version"